---
export const prerender = false; // Render on Server

// TYPES //
import type { AlbumsItemData } from "@/types/media/albums";

// COMPONENTS //
import FilterBar from "@/components/FilterBar.astro";
import SectionHeaderMain from "@/components/SectionHeaderMain.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import ImageCard from "@/components/ImageCard.astro";
import Lightbox from "@/components/Lightbox.astro";
import EmptyState from "@/components/EmptyState.astro";
import Pagination from "@/components/Pagination.astro";

// CONSTANTS //
import { URLS } from "@/infrastructure/constants/urls";

// OTHERS //
import Layout from "@/layouts/Layout.astro";

// META //
import albumsMeta from "@/data/meta/media/albums/albums.json";

// DATA //
import {
  albums,
  albumsBreadcrumbItems,
  albumsSectionHeader,
} from "@/data/media/albums";

// Get the Year from the Search Params
const year: number =
  Number(Astro.url.searchParams.get("year")) || albums.years[0];

// If streamId is missing or invalid â€” go back or redirect
if (!year) {
  return new Response(null, {
    status: 302,
    headers: {
      Location: Astro.request.headers.get("referer") || URLS.HOME,
    },
  });
}

const albumsItems: AlbumsItemData[] = albums.images[year] ?? [];

// Get this from API
const totalItems = albumsItems.length;
const totalPages = totalItems > 0 ? Math.ceil(totalItems / 10) : 0;

const shouldShowPagination = totalPages > 1;
---

<Layout meta={albumsMeta}>
  <section class="bg-n-50 relative w-full overflow-hidden">
    <div
      class="container m-auto flex flex-col gap-10 px-5 pt-32 pb-14 md:gap-14 lg:gap-16 lg:pt-40"
    >
      <!-- Breadcrumbs -->
      <Breadcrumbs items={albumsBreadcrumbItems} />

      <!-- Body of the Albums -->
      <div class="flex flex-col gap-8 md:gap-12 lg:gap-14">
        <!-- Section Header -->
        <SectionHeaderMain
          title={albumsSectionHeader.title}
          subtitle={albumsSectionHeader.subtitle}
          eyebrowText={albumsSectionHeader.eyebrowText}
        />

        <!-- Albums -->
        <div class="fade-in flex flex-col gap-7 md:gap-8 lg:gap-11">
          <!-- Years Filters -->
          <div class="fade-in">
            <FilterBar showSearch={false} years={albums.years} />
          </div>

          <!-- Albums -->
          {
            albumsItems && albumsItems.length > 0 ? (
              <div class="grid grid-cols-1 gap-5 md:grid-cols-2 md:gap-6 lg:grid-cols-3 xl:grid-cols-4">
                {albumsItems.map(
                  (albumItem: AlbumsItemData, albumsItemIndex) => (
                    <a
                      href={`${URLS.MEDIA.ALBUMS.ITEM(
                        albumItem.id.toString(),
                      )}?year=${year}`}
                    >
                      <div
                        class="card-anim"
                        style={`--delay: ${albumsItemIndex * 0.2}s`}
                      >
                        <ImageCard
                          image={albumItem.image}
                          caption={albumItem.name}
                          index={albumItem.id}
                          classes="max-h-[350px] md:h-[350px]"
                          showExpandButton={false}
                        />
                      </div>
                    </a>
                  ),
                )}
              </div>
            ) : (
              <EmptyState />
            )
          }
        </div>
        <!-- Pagination -->
        {shouldShowPagination && <Pagination totalPages={totalPages} />}
        <Lightbox />
      </div>
    </div>
  </section>
</Layout>
