---
export const prerender = false; // Render on Server

// LAYOUT //
import Layout from "@/layouts/Layout.astro";

// META //
import cbse10thMeta from "@/data/meta/results/cbse-10th/cbse-10th.json";

// COMPONENTS //
import FilterBar from "@/components/ui/FilterBar.astro";
import SectionHeaderMain from "@/components/ui/SectionHeaderMain.astro";
import Breadcrumbs from "@/components/ui/Breadcrumbs.astro";
import ResultsCard from "@/components/ui/ResultsCard.astro";
import EmptyState from "@/components/ui/EmptyState.astro";

// API SERVICES //
import { fetchResultsRequest } from "@/services/api/results.api.service";

// UTILS //
import { generateImagePath } from "@/utils/image.utils";

// DATA //
import {
  cbseTenth,
  cbseTenthBreadcrumbItems,
  cbseTenthSectionHeader,
} from "@/data/results/cbse-10th";
import { URLS } from "@/infrastructure/constants/urls";
import { IMAGE_TYPES } from "@/enums/image.enum";

// Get the Year from the Search Params
const urlYear = Astro.url.searchParams.get("year");

// Default to the first available year in the config if URL param is missing
const year: number = urlYear ? Number(urlYear) : new Date().getFullYear();

// Fetch Results from API (Hardcoded ID 7 for 10th Grade)
// This replaces the old 'cbseTenth.results[year]' line
const results = await fetchResultsRequest(year, "7"); // 7 is the ID of 10th

// If year is invalid â€” go back or redirect
if (!year) {
  return new Response(null, {
    status: 302,
    headers: {
      Location: Astro.request.headers.get("referer") || URLS.HOME,
    },
  });
}
---

<Layout meta={cbse10thMeta}>
  <section class="bg-n-50 relative w-full overflow-hidden">
    <div
      class="container m-auto flex flex-col gap-10 px-5 pt-32 pb-14 md:gap-14 lg:gap-16 lg:pt-40"
    >
      <Breadcrumbs items={cbseTenthBreadcrumbItems} />

      <div class="flex flex-col gap-8 md:gap-12 lg:gap-14">
        <SectionHeaderMain
          title={cbseTenthSectionHeader.title}
          subtitle={cbseTenthSectionHeader.subtitle}
        />

        <div class="flex flex-col gap-7 md:gap-8 lg:gap-11">
          <FilterBar showSearch={false} years={cbseTenth.years} />

          {results && results.length > 0 ? (
          <div
            class="grid grid-cols-1 gap-5 md:grid-cols-2 md:gap-6 lg:grid-cols-3"
          >
            {
              results.map((student: any) => (
                  <ResultsCard
                    studentName={student.studentName}
                    score={student.percentage}
                    /* Dynamic Image URL for 10th Results */
                    image={generateImagePath(
                      student.studentProfilePic,
                      IMAGE_TYPES.RESULT
                    )}
                  />
                ))
            }
          </div>
          ) : (
            <EmptyState title="No Results Found" description="We couldn't find any results for the selected year. Please check back later." />
          )}
        </div>
      </div>
    </div>
  </section>
</Layout>