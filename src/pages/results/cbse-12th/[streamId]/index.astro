---
export const prerender = false; // Render on Server

// 1. LAYOUT & COMPONENTS
import Layout from "@/layouts/Layout.astro";
import SectionHeaderMain from "@/components/ui/SectionHeaderMain.astro";
import Breadcrumbs from "@/components/ui/Breadcrumbs.astro";
import ResultsCard from "@/components/ui/ResultsCard.astro";
import EmptyState from "@/components/ui/EmptyState.astro";

// 2. IMPORT API & UTILS
import { fetchResultsRequest } from "@/services/api/results.api.service";
import { generateResultImagePath } from "@/utils/image.utils";

// 3. GET PARAMS
const { streamId } = Astro.params; 

// Get Year (Default to 2025)
const urlYear = Astro.url.searchParams.get("year");
const currentYear = urlYear ? Number(urlYear) : 2025; 

// 4. FETCH DATA
const results = await fetchResultsRequest(currentYear, streamId ?? "11");

// 5. DETERMINE TITLE (REMOVED "Results" word)
// If API gives a class name (e.g. "XII Science"), use it directly.
// Otherwise, fall back to "Class 11".
const pageTitle = (results && results.length > 0 && results[0].className) 
  ? results[0].className 
  : `Class ${streamId}`;

// 6. SET FOLDER TYPE
const PAGE_TYPE = "results"; 

// BREADCRUMBS
const breadcrumbItems = [
  { label: "12th Results", href: "/results/cbse-12th" },
  { label: pageTitle, href: "#" },
];

const pageMeta = {
  title: `${pageTitle} - ${currentYear}`,
  description: `Celebrating our students hard work`
};
---

<Layout meta={pageMeta}>
  <section class="bg-n-50 relative w-full overflow-hidden">
    <div
      class="container m-auto flex flex-col gap-10 px-5 pt-32 pb-14 md:gap-14 lg:gap-16 lg:pt-40"
    >
      <Breadcrumbs items={breadcrumbItems} />

      <div class="flex flex-col gap-8 md:gap-12 lg:gap-14">
        
        <SectionHeaderMain
          title={pageTitle}
          subtitle="Celebrating our students hard work and achievements"
        />

        <div class="flex flex-col gap-7 md:gap-8 lg:gap-11">
          
          <div
            class="grid grid-cols-1 gap-5 md:grid-cols-2 md:gap-6 lg:grid-cols-3 xl:grid-cols-4"
          >
            {
              results && results.length > 0 ? (
                results.map((student) => (
                  <ResultsCard
                    studentName={student.studentName}
                    score={student.percentage}
                    image={generateResultImagePath(student.studentProfilePic, PAGE_TYPE)}
                  />
                ))
              ) : (
                <EmptyState />
              )
            }
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>