---
export const prerender = false; // Render on Server

// LAYOUT //
import Layout from "@/layouts/Layout.astro";

// COMPONENTS //
import FilterBar from "@/components/FilterBar.astro";
import SectionHeaderMain from "@/components/SectionHeaderMain.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import ResultsCard from "@/components/ResultsCard.astro";

// DATA //
import { cbseClasses } from "@/data/results/cbse-12th";
import { URLS } from "@/infrastructure/constants/urls";

// TYPES //
import type { ClassData, ResultData } from "@/types/results/results";

// Get the Props from the URL [stream]/[year]
const { streamId } = Astro.params;

// Get the Year from the Search Params
const year = Astro.url.searchParams.get("year");

// Get the Class Object from "chseClasses" data using the Stream ID
// TODO: WIll be API Call here
const classItem: ClassData | undefined = cbseClasses.find(
  (cbseClassItem) => cbseClassItem.id === parseInt(streamId ?? "0"),
);

// If streamId is missing or invalid â€” go back or redirect
if (!streamId || !year || !classItem) {
  return new Response(null, {
    status: 302,
    headers: {
      Location: Astro.request.headers.get("referer") || URLS.HOME,
    },
  });
}

const results: ResultData[] = classItem.results[parseInt(year)];

// Breadcrumb Items
const breadcrumbItems = [
  { label: "12th Results", href: URLS.RESULTS.CBSE_12.ROOT },
  {
    label: classItem.name,
    href: `${URLS.RESULTS.CBSE_12.STREAM(streamId)}/${classItem?.years[0]}`,
  },
];
---

<Layout>
  <div class="container">
    <!-- Breadcrumbs -->
    <div class="bg-n-50 relative w-full overflow-hidden">
      <div
        class="container mx-auto px-6 pt-30 pb-5 md:pt-40 md:pb-8 lg:pb-9 2xl:px-0"
      >
        <Breadcrumbs items={breadcrumbItems} />
      </div>
    </div>

    <!-- Section Header -->
    <SectionHeaderMain
      title={classItem.name}
      subtitle="Celebrating our students hard work and achievements"
    />

    <section class="bg-n-50 relative w-full overflow-hidden">
      <div
        class="container mx-auto flex flex-col gap-10 px-6 md:gap-14 lg:gap-9 2xl:px-0"
      >
        <div class="flex flex-col gap-8 md:gap-12">
          <div class="flex flex-col gap-7 md:gap-8">
            <!-- Years Filters -->
            <FilterBar showSearch={false} years={classItem.years} />

            <!-- Results -->
            <div
              class="grid grid-cols-1 gap-5 md:grid-cols-2 md:gap-6 lg:grid-cols-3 2xl:grid-cols-4 2xl:gap-8"
            >
              {
                results?.map((resultItem) => (
                  <ResultsCard
                    studentName={resultItem.studname}
                    score={resultItem.percentage}
                    image={resultItem.studprofilepic}
                  />
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</Layout>
