---
// COMPONENTS //
import Input from "@/components/ui/Input.astro";
import StepCard from "@/components/ui/FormStepsCard.astro";
import Select from "@/components/ui/Select.astro";
import Textarea from "@/components/ui/Textarea.astro";
import Button from "@/components/ui/Button.astro";
import SectionHeader from "@/components/ui/SectionHeader.astro";
import Image from "astro/components/Image.astro";

// DATA //
import { grades } from "@/data/admissions/form";

const STEP_TITLES = ["About Student", "About Parent", "Boarding Preference"];
---

<section id="admission-section" class="bg-n-100 mx-auto w-full space-y-6">
  <div
    class="container mx-auto flex flex-col gap-16 px-6 py-12 md:py-24 lg:px-8 2xl:px-6"
  >
    <!-- Section Header -->
    <SectionHeader
      title="Now what are you waiting for? Let‚Äôs Begin Your SAI Journey"
      subtitle="A few details from you, and we‚Äôll be in touch with care, clarity, and guidance."
    />

    <!-- ONE form for all steps -->
    <form id="admission-form">
      <!-- STEP 1 -->

      <StepCard id="step-1" step={1} total={3} title={STEP_TITLES[0]}>
        <div class="flex flex-col gap-14 md:gap-24">
          <div
            class="grid grid-cols-1 gap-x-20 gap-y-6 sm:grid-cols-2 md:gap-y-9"
          >
            <!-- Student Name Input -->
            <div data-field>
              <Input
                label="Student‚Äôs Full Name"
                name="name"
                required
                placeholder="Enter Full Name"
                errorMessage="Student name is required and should not contain numbers.."
              />
            </div>

            <!-- Academic Year Select -->
            <Select
              label="Admission for Academic Year"
              name="academicyear_name"
              placeholder="Select Year"
              required
              options={[
                { label: "2025‚Äì2026", value: "2025-26" },
                { label: "2026‚Äì2027", value: "2026-27" },
              ]}
              errorMessage="Please select the academic year."
            />

            <!-- DOB Input -->
            <div data-field>
              <Input
                label="Student‚Äôs Date of Birth"
                name="dob"
                type="date"
                required
                errorMessage="Date of birth is required."
              />
            </div>

            <!-- Class Select -->
            <Select
              label="Admission for Class"
              name="className"
              required
              placeholder="Select Class"
              options={grades}
              errorMessage="Please select the class for admission."
            />
          </div>

          <div class="flex flex-wrap items-end justify-between gap-8">
            <p class="text-n-500 text-base font-normal md:text-xl">
              We welcome learners from all backgrounds and cities.
            </p>
            <!-- Button: Continue to next step -->
            <Button
              id="next-1"
              type="button"
              text="Continue to Parent Info"
              variant="solid"
              size="medium"
            />
          </div>
        </div>
      </StepCard>

      <!-- STEP 2 -->
      <StepCard
        id="step-2"
        step={2}
        total={3}
        title={STEP_TITLES[1]}
        class={"hidden"}
      >
        <div class="flex flex-col gap-14 md:gap-24">
          <div
            class="grid grid-cols-1 gap-x-20 gap-y-6 sm:grid-cols-2 md:gap-y-9"
          >
            <!-- Parent/Guardian Input -->
            <div data-field>
              <Input
                label="Parent / Guardian‚Äôs Full Name"
                name="parentName"
                required
                errorMessage="Parent/Guardian name is required and should not contain numbers..."
              />
            </div>

            <!-- Phone Input -->
            <div data-field>
              <Input
                label="Phone Number"
                name="mobileNo"
                type="tel"
                required
                errorMessage="Enter a valid 10-digit number."
              />
            </div>

            <!-- Email Input -->
            <div data-field>
              <Input
                label="Email ID"
                name="emailId"
                type="email"
                required
                errorMessage="Enter a valid email address."
              />
            </div>
          </div>

          <div class="flex flex-wrap items-center justify-between gap-8">
            <p
              class="text-n-500 text-base font-medium md:text-xl xl:flex xl:flex-1"
            >
              This is how we‚Äôll get in touch with you. We don‚Äôt spam, promise.
            </p>
            <div class="flex flex-wrap gap-3">
              <!-- Back button -->
              <Button
                id="back-2"
                type="button"
                text="Back to Child Details"
                variant="ghost"
                size="medium"
                extraClasses="border border-n-300 bg-white text-n-800 hover:bg-n-100"
              />
              <!-- Continue button -->
              <Button
                id="next-2"
                type="submit"
                text="Continue to Preferences"
                variant="solid"
                size="medium"
              />
            </div>
          </div>
        </div>
      </StepCard>

      <!-- STEP 3 -->
      <StepCard
        id="step-3"
        step={3}
        total={3}
        title={STEP_TITLES[2]}
        class={"hidden"}
      >
        <!-- Fields wrapper -->
        <div class="flex flex-col gap-14 md:gap-24">
          <div
            class="grid grid-cols-1 gap-x-20 gap-y-6 sm:grid-cols-2 md:gap-y-9"
          >
            <!-- Hotel Required Select -->
            <Select
              label="Hostel Required"
              name="hostel"
              placeholder="Select"
              required
              options={[
                { label: "Not Sure Yet", value: "maybe" },
                { label: "Yes", value: "yes" },
                { label: "No", value: "no" },
              ]}
              errorMessage="Please select an option."
            />

            <!-- Message textarea -->
            <Textarea
              label="Message"
              name="message"
              placeholder="Any specific concerns, requests, or child interests?"
              errorMessage="Message is required."
              required
              rows={2}
            />
          </div>

          <div class="flex flex-wrap items-center justify-between gap-8">
            <p
              class="text-n-500 flex text-base font-medium md:text-xl xl:flex-1"
            >
              Let us know if you‚Äôd like your child to avail hostel facilities.
              This helps us guide you better.
            </p>
            <div class="flex flex-wrap gap-3">
              <!-- Back button -->
              <Button
                id="back-3"
                type="button"
                text="Back to Parent Info"
                variant="ghost"
                size="medium"
                extraClasses="border border-n-300 bg-n-50 text-n-800 hover:bg-n-100"
              />
              <!-- Submit button -->
              <Button
                id="submit"
                type="submit"
                text="Submit Inquiry"
                variant="solid"
                size="medium"
                extraClasses="bg-[#C9443A]/80 hover:bg-orange-500 text-n-50"
              />
            </div>
          </div>
        </div>
      </StepCard>

      <!-- THANK YOU -->
      <article
        id="thank-you"
        class="border-n-200 slide-parent stagger bg-n-50 flex flex-col items-center gap-8 rounded-3xl border px-6 py-8 text-center md:gap-10 md:py-12 lg:gap-12 lg:py-24"
      >
        <!-- Paper plan icon -->
        <Image
          src="/icons/paper-plane.svg"
          alt=""
          class="floating-icon h-12 -rotate-10 md:h-24 lg:h-32"
          width={128}
          height={128}
        />
        <div class="flex flex-col items-center gap-2">
          <!-- Success panel title -->
          <p
            class="text-n-700 font-secondary text-sm font-light md:text-lg lg:text-2xl"
          >
            We‚Äôre excited to begin this journey with you.
          </p>
          <p
            class="text-n-700 lg::w-[65%] w-[90%] text-center text-2xl leading-tight font-normal md:w-[75%] md:text-4xl lg:text-5xl lg:leading-[56px]"
          >
            At SAI International, your child is not just admitted, but truly
            welcomed.
          </p>
        </div>

        <!-- Success panel message -->
        <p
          class="text-n-600 font-secondary text-sm font-medium md:text-lg lg:text-2xl"
        >
          Our admissions team will be in touch with you shortly.
        </p>
        <!-- Download brochure button -->
        <Button text="Download Brochure" variant="outline" />
      </article>

      <!-- SUBMITTING SCREEN -->
      <article
        id="submitting"
        class="bg-n-50 flex hidden flex-col items-center gap-6 py-16 text-center"
      >
        <div class="loader"></div>
        <p class="text-n-700 text-xl font-medium md:text-2xl">
          Submitting your form, please wait‚Ä¶
        </p>
      </article>
    </form>
  </div>
</section>

<style>
  /* Parent slide animation */
  .slide-parent {
    opacity: 0;
    transform: translateY(30px);
    animation: slideParent 0.45s ease-out forwards;
  }

  @keyframes slideParent {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Stagger children */
  .stagger > * {
    opacity: 0;
    transform: translateY(20px);
    animation: slideChild 0.5s ease-out forwards;
    &:nth-child(1) {
      opacity: 1;
      animation: float 6s ease-in-out infinite;
      will-change: transform;
    }
  }

  .stagger > *:nth-child(2) {
    animation-delay: 0.3s;
  }
  .stagger > *:nth-child(3) {
    animation-delay: 0.45s;
  }
  .stagger > *:nth-child(4) {
    animation-delay: 0.6s;
  }

  @keyframes slideChild {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Loader animation */
  .loader {
    width: 48px;
    height: 48px;
    border: 4px solid #e0e0e0;
    border-top-color: #c9443a;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }

  @keyframes float {
    0% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-16px);
    }
    100% {
      transform: translateY(0);
    }
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  import { admissionEnquiryRequest } from "@/services/api/form.api.service";
  window.addEventListener("DOMContentLoaded", () => {
    const steps = [
      document.getElementById("step-1"),
      document.getElementById("step-2"),
      document.getElementById("step-3"),
    ];
    const thankYou = document.getElementById("thank-you");

    const showStep = (idx: number) => {
      steps.forEach((el, i) => el?.classList.toggle("hidden", i !== idx));
      thankYou?.classList.add("hidden");
    };

    // Initially show step 1
    showStep(0);

    // ‚úÖ Validation
    const validateStep = (stepEl: any) => {
      if (!stepEl) return false;
      const fields = stepEl.querySelectorAll("input, select, textarea");
      let valid = true;

      fields.forEach((el: any) => {
        const errorText = el
          .closest("[data-field]")
          ?.querySelector("[data-error]");
        let fieldValid = true;

        if (el.hasAttribute("required") && !el.value.trim()) fieldValid = false;

        if (el.type === "email" && el.value.trim() !== "") {
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(el.value.trim())) fieldValid = false;
        }

        // ‚ùå NAME VALIDATION: should NOT contain digits
        if (
          el.name === "parentName" ||
          (el.name === "name" && el.value !== "")
        ) {
          const hasDigits = /\d/.test(el.value);
          if (hasDigits) fieldValid = false;
        }

        // ‚ùå PHONE VALIDATION: should contain ONLY digits
        if (el.name === "mobileNo" && el.value !== "") {
          const notNumbers = /\D/.test(el.value);
          if (notNumbers) fieldValid = false;
        }

        if (!fieldValid) {
          valid = false;
          el.classList.add("border-red-500", "focus:ring-red-500");
          errorText?.classList.remove("hidden");
        } else {
          el.classList.remove("border-red-500", "focus:ring-red-500");
          errorText?.classList.add("hidden");
        }
      });

      return valid;
    };

    // ‚úÖ Step navigation
    document.getElementById("next-1")?.addEventListener("click", () => {
      showStep(1);
    });

    document.getElementById("next-2")?.addEventListener("click", (e) => {
      e.preventDefault();
      showStep(2);
    });

    document
      .getElementById("back-2")
      ?.addEventListener("click", () => showStep(0));
    document
      .getElementById("back-3")
      ?.addEventListener("click", () => showStep(1));

    /** üî• Convert your form fields ‚Üí LeadSquared Attribute/Value array  */
    const mapToLeadSquared = (formObj: any) => {
      return [
        { Attribute: "Student's Full Name", Value: formObj.name || "" },
        { Attribute: "Email Address", Value: formObj.emailId || "" },
        { Attribute: "Phone", Value: formObj.mobileNo || "" },
        { Attribute: "Student DOB", Value: formObj.dob || "" },
        { Attribute: "Admission Year", Value: formObj.academicyear_name || "" },
        { Attribute: "Class Name", Value: formObj.className || "" },
        { Attribute: "Parent Name", Value: formObj.parentName || "" },
        { Attribute: "Hostel", Value: formObj.hostel || "" },
        { Attribute: "Message", Value: formObj.message || "" },
      ];
    };

    // ‚úÖ Submit handler
    document.getElementById("submit")?.addEventListener("click", async (e) => {
      e.preventDefault();
      // if (!validateStep(steps[2])) return;

      const form = document.querySelector("form") as HTMLFormElement;
      const formData = new FormData(form);
      const formObj = Object.fromEntries(formData.entries());

      // Convert to LeadSquared format
      const leadSquaredPayload = mapToLeadSquared(formObj);

      const submitting = document.getElementById("submitting");

      // Hide steps, reset visibility
      steps.forEach((el) => el?.classList.add("hidden"));
      thankYou?.classList.add("hidden");

      // Remove old animation classes to re-trigger
      submitting?.classList.remove("slide-parent");
      submitting?.offsetHeight; // force reflow
      submitting?.classList.add("slide-parent");

      // Show submitting screen
      submitting?.classList.remove("hidden");

      try {
        const response = await admissionEnquiryRequest(leadSquaredPayload);

        // Check LSQ errors
        if (response.ExceptionMessage || response.Status !== "Success") {
          alert(
            "Something went wrong submitting your enquiry. Please try again.",
          );
          return;
        }

        // Hide loader & show thank you with stagger animation
        submitting?.classList.add("hidden");

        thankYou?.classList.remove("slide-parent");
        thankYou?.offsetHeight;
        thankYou?.classList.add("slide-parent");

        thankYou?.classList.remove("hidden");
      } catch (err) {
        submitting?.classList.add("hidden");
        console.error("‚ùå Failed to submit enquiry:", err);
        alert(
          "Something went wrong while submitting your enquiry. Please try again.",
        );
      }
    });
  });
</script>
