---
import Input from "@/components/ui/Input.astro";
import StepCard from "@/components/ui/FormStepsCard.astro";
import Select from "@/components/ui/Select.astro";
import Textarea from "@/components/ui/Textarea.astro";
import Button from "@/components/ui/Button.astro";
import SectionHeaderMain from "@/components/ui/SectionHeaderMain.astro";
import Image from "astro/components/Image.astro";
---

<section
  class="bg-n-100 mx-auto w-full space-y-6"
  id="contact-form"
  data-section="Contact Us"
>
  <div
    class="container mx-auto flex flex-col gap-16 px-6 py-12 md:py-24 lg:px-8 2xl:px-0"
  >
    <!-- Section Header -->
    <SectionHeaderMain
      title="Got a Question? Just Ask."
      subtitle="Fill in your details, and one of our team members will reach out shortly."
    />

    <!-- ONE form for all steps -->
    <form id="contact-form">
      <!-- STEP 1 -->
      <StepCard id="step-1" total={3}>
        <div class="flex flex-col gap-14 md:gap-20">
          <div
            class="grid grid-cols-1 gap-x-20 gap-y-6 sm:grid-cols-2 md:gap-y-9"
          >
            <!-- Name Input -->
            <div data-field>
              <Input
                label="Full Name"
                name="fullName"
                required
                placeholder="Enter full name"
                errorMessage="Full name cannot be empty and should not contain numbers."
              />
            </div>

            <!-- Phone number -->
            <div data-field>
              <Input
                label="Phone Number"
                name="phoneNumber"
                type="number"
                required
                placeholder="Enter phone number"
                errorMessage="Phone number is required and must contain 10 digits."
              />
            </div>

            <!-- Email Input -->
            <div data-field>
              <Input
                label="Email Address"
                name="email"
                type="email"
                required
                placeholder="Enter email address"
                errorMessage="A valid Email is required."
              />
            </div>

            <!-- Reason for contact -->
            <Select
              label="Reason for contact"
              name="reason"
              placeholder="Select reason"
              required
              options={[
                {
                  label: "Want to understand school processes",
                  value: "Want to understand school processes",
                },
                {
                  label: "Understand school processes",
                  value: "Understand school processes",
                },
              ]}
              errorMessage="Please select the reason"
            />

            <!-- Message textarea -->
            <div class="sm:col-span-2" data-field>
              <Textarea
                label="Message"
                name="message"
                placeholder="Any specific concerns, requests, or child interests?"
                errorMessage="Message is required."
              />
            </div>
          </div>

          <div class="flex flex-wrap items-end justify-between gap-8 self-end">
            <!-- Button: Continue to next step -->
            <Button
              id="next-1"
              type="submit"
              text="Send Message"
              variant="solid"
              size="large"
            />
          </div>
        </div>
      </StepCard>

      <!-- THANK YOU -->
      <article
        id="thank-you"
        class="border-n-200 bg-n-50 slide-parent stagger flex flex-col items-center gap-6 rounded-3xl border px-6 py-8 text-center md:gap-8 md:py-12 lg:gap-10 lg:py-24"
      >
        <!-- Paper plan icon -->
        <Image
          src="/icons/paper-plane.svg"
          alt=""
          class="floating-icon h-12 -rotate-10 md:h-24 lg:h-32"
          width={128}
          height={128}
        />
        <div class="flex flex-col items-center gap-2">
          <!-- Success panel title -->
          <p
            class="text-n-700 w-full text-center text-2xl leading-tight font-normal md:text-4xl lg:text-5xl"
          >
            Thank you for reaching out.
          </p>
        </div>

        <!-- Success panel message -->
        <p
          class="text-n-600 font-secondary text-sm font-medium md:text-lg lg:text-2xl"
        >
          We’ve received your message and our team will be in touch with you
          shortly.
        </p>
        <!-- Download brochure button -->
        <Button
          text="Back to Home"
          variant="outline"
          size="large"
          onClick="window.location='/'"
        />
      </article>
    </form>
  </div>
</section>

<style>
  /* Parent slide animation */
  .slide-parent {
    opacity: 0;
    transform: translateY(30px);
    animation: slideParent 0.45s ease-out forwards;
  }

  @keyframes slideParent {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Stagger children */
  .stagger > * {
    opacity: 0;
    transform: translateY(20px);
    animation: slideChild 0.5s ease-out forwards;
    &:nth-child(1) {
      opacity: 1;
      animation: float 6s ease-in-out infinite;
      will-change: transform;
    }
  }

  .stagger > *:nth-child(2) {
    animation-delay: 0.3s;
  }
  .stagger > *:nth-child(3) {
    animation-delay: 0.45s;
  }
  .stagger > *:nth-child(4) {
    animation-delay: 0.6s;
  }

  @keyframes slideChild {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes float {
    0% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-16px);
    }
    100% {
      transform: translateY(0);
    }
  }
</style>
<script>
  import { EVENTS } from "@/enums/analytics.enum";
  import {
    setupFormStartTracking,
    setupInViewTracking,
    trackFormViewEvent,
  } from "@/scripts/analytics";

  const form = document.querySelector(
    "form#contact-form",
  ) as HTMLFormElement | null;

  if (form) {
    setupFormStartTracking(form, EVENTS.ENQUIRY_FORM_STARTED);
    // Track when form comes into view
    setupInViewTracking("contact-form", () => {
      trackFormViewEvent("contact-form", EVENTS.ENQUIRY_FORM_VIEWED);
    });
  }
</script>

<script>
  // ENUMS //
  import { EVENTS } from "@/enums/analytics.enum";

  // SCRIPTS //
  import { trackEvent } from "@/scripts/analytics";

  // SERVICES //
  import { contactEnquiryRequest } from "@/services/api/form.api.service";

  window.addEventListener("DOMContentLoaded", () => {
    const step1 = document.getElementById("step-1");
    const thankYou = document.getElementById("thank-you");
    const next1 = document.getElementById("next-1");

    // ✅ Ensure initial state
    step1?.classList.remove("hidden");
    thankYou?.classList.add("hidden");

    // ✅ Validation function (same as admission form)
    const validateStep = (stepEl: HTMLElement) => {
      if (!stepEl) return false;
      const fields = stepEl.querySelectorAll("input, select, textarea");
      let valid = true;

      fields.forEach((el) => {
        const errorText = el
          .closest("[data-field]")
          ?.querySelector("[data-error]");
        let fieldValid = true;
        const value = el.value.trim();

        // Required check
        if (el.hasAttribute("required") && !value) fieldValid = false;

        // Email check
        if (el.type === "email" && value !== "") {
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(value)) fieldValid = false;
        }

        // ❌ NAME VALIDATION: should NOT contain digits
        if (el.name === "fullName" && value !== "") {
          const hasDigits = /\d/.test(value);
          if (hasDigits) fieldValid = false;
        }

        // ❌ PHONE VALIDATION: should contain ONLY digits
        if (el.name === "phoneNumber" && value !== "") {
          const notNumbers = /\D/.test(value);
          if (notNumbers || el.value.length !== 10) fieldValid = false;
        }

        // Style updates
        if (!fieldValid) {
          valid = false;
          el.classList.add("border-red-500", "focus:ring-red-500");
          errorText?.classList.remove("hidden");
        } else {
          el.classList.remove("border-red-500", "focus:ring-red-500");
          errorText?.classList.add("hidden");
        }
      });

      return valid;
    };

    // ✅ Submit handler (Send Message)
    next1?.addEventListener("click", async (e) => {
      e.preventDefault();

      // Validate step
      if (!validateStep(step1)) return;

      // Collect form data
      const form = document.querySelector("form");

      if (!form) return;

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      console.log(step1, payload);

      try {
        // Call API
        const response = await contactEnquiryRequest(payload);

        if (response.status === false) {
          alert(
            "Something went wrong while submitting your enquiry. Please try again.",
          );
          return;
        }

        // Track enquiry submitted event
        trackEvent(EVENTS.ENQUIRY_FORM_COMPLETED, payload);

        // Show thank you screen
        step1?.classList.add("hidden");
        thankYou?.classList.remove("hidden");
      } catch (err) {
        console.error("❌ Failed to submit enquiry:", err);
        alert(
          "Something went wrong while submitting your enquiry. Please try again.",
        );
      }
    });
  });
</script>
