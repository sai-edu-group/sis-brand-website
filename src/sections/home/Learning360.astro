---
// COMPONENTS //
import LearningContent from "@/components/LearningContent.astro";
import SectionHeaderMain from "@/components/SectionHeaderMain.astro";

// DATA //
import { learning360Content } from "@/data/home/learning-360";
---

<section id="learning-360">
  <div
    class="container mx-auto flex flex-col gap-10 px-3 py-14 md:gap-11 md:py-20 lg:gap-12 lg:pt-24"
  >
    <!-- Header -->
    <SectionHeaderMain
      eyebrowText="Learning @ 360"
      title="Education That Shapes Every Side of a Child"
      subtitle="Shaping confident, compassionate, and future-ready learners."
    />

    <!-- Tabs -->
    <div class="flex w-full flex-col items-start gap-3.5 lg:gap-6">
      <div
        id="learning-tabs"
        class="scrollbar-hide flex w-full items-center justify-start gap-3 overflow-x-auto md:gap-5 lg:gap-6"
      >
        {
          learning360Content.map(
            (learning360ContentItem, learning360ContentIndex) => (
              <div
                class={`tab-item flex cursor-pointer flex-col items-center rounded-xl border-2 border-transparent p-3 transition-colors hover:border-orange-500 md:px-3.5 md:py-4 ${
                  learning360ContentIndex === 0 ? "bg-orange-500" : "bg-white"
                }`}
                data-index={learning360ContentIndex}
              >
                <p
                  class={`font-secondary text-xs leading-[1.3] whitespace-nowrap md:text-sm lg:text-base ${
                    learning360ContentIndex === 0 ? "text-n-50" : "text-n-600"
                  }`}
                >
                  {learning360ContentItem.title}
                </p>
              </div>
            ),
          )
        }
      </div>

      <!-- Pre-rendered content sections -->
      <div id="learning-sections" class="w-full">
        {
          learning360Content.map(
            (learning360ContentItem, learning360ContentIndex) => (
              <div
                class={`learning-section ${learning360ContentIndex === 0 ? "block" : "hidden"}`}
                data-index={learning360ContentIndex}
              >
                <LearningContent
                  items={learning360ContentItem.items}
                  title={learning360ContentItem.title}
                />
              </div>
            ),
          )
        }
      </div>
    </div>
  </div>
</section>

<!-- Modular accordion + tabs with autoplay/progress -->
<script type="module">
  import { initAccordion } from "/js/accordion.js";

  const tabsContainer = document.getElementById("learning-tabs");
  const sectionEls = Array.from(document.querySelectorAll(".learning-section"));

  /* ---------- IMAGE SYNC ---------- */

  // Updates the main image inside a section based on the active accordion item
  function updateSectionImage(sectionEl) {
    const activeImg = sectionEl.querySelector("[data-active-image]");
    if (!activeImg) return;

    const openItem =
      sectionEl.querySelector('[data-accordion-item][data-open="true"]') ||
      sectionEl.querySelector("[data-accordion-item]");

    const newImgUrl = openItem?.dataset?.img;
    if (!newImgUrl) return;

    // Skip update if already showing this image
    const currentSrc = activeImg.getAttribute("src");
    if (currentSrc === newImgUrl) return;

    // Fade transition
    activeImg.style.transition = "opacity 220ms ease";
    activeImg.style.opacity = 0;

    setTimeout(() => {
      activeImg.setAttribute("src", newImgUrl);
      activeImg.style.opacity = 1;
    }, 220);
  }

  // Attach listeners to keep image and accordion in sync
  function enableImageSync(sectionEl) {
    const accordionRoot = sectionEl.querySelector("[data-accordion]");
    if (!accordionRoot) return;

    updateSectionImage(sectionEl);

    // When clicking toggle headers, recheck image
    accordionRoot.addEventListener("click", (e) => {
      if (e.target.closest("[data-accordion-toggle]")) {
        setTimeout(() => updateSectionImage(sectionEl), 50);
      }
    });

    // Watch for attribute changes (accordion open/close)
    const accordionItems = sectionEl.querySelectorAll("[data-accordion-item]");
    const observer = new MutationObserver((mutations) => {
      for (const m of mutations) {
        if (m.attributeName === "data-open") {
          updateSectionImage(sectionEl);
          break;
        }
      }
    });

    accordionItems.forEach((item) =>
      observer.observe(item, {
        attributes: true,
        attributeFilter: ["data-open"],
      }),
    );

    accordionRoot.__imgObserver = observer;
  }

  function disableImageSync(sectionEl) {
    const accordionRoot = sectionEl.querySelector("[data-accordion]");
    if (accordionRoot?.__imgObserver) {
      accordionRoot.__imgObserver.disconnect();
      accordionRoot.__imgObserver = null;
    }
  }

  /* ---------- ACCORDION CONTROL ---------- */

  function getAccordionAPI(sectionEl) {
    const root = sectionEl.querySelector("[data-accordion]");
    return root ? root.__acc : null;
  }

  function destroyOtherSectionAccordions(activeIndex) {
    sectionEls.forEach((sectionEl, i) => {
      if (i === activeIndex) return;

      const accordionRoot = sectionEl.querySelector("[data-accordion]");
      if (accordionRoot?.__acc) {
        accordionRoot.__acc.destroy();
        accordionRoot.__acc = null;
      }

      disableImageSync(sectionEl);
    });
  }

  function setupSectionAccordion(sectionEl) {
    const accordionRoot = sectionEl.querySelector("[data-accordion]");
    if (!accordionRoot) return;

    if (accordionRoot.__acc) {
      accordionRoot.__acc.destroy();
      accordionRoot.__acc = null;
    }

    accordionRoot.__acc = initAccordion(accordionRoot, {
      autoplay: true,
      cycleMs: 6000,
      progressDurationMs: 6000,
    });

    enableImageSync(sectionEl);
    updateSectionImage(sectionEl);
  }

  /* ---------- TAB SWITCHING ---------- */

  function activateTab(tabIndex) {
    const tabButtons = Array.from(tabsContainer.querySelectorAll(".tab-item"));

    // Reset tab styles
    tabButtons.forEach((btn) => {
      btn.classList.remove("bg-orange-500");
      btn.classList.add("bg-white");
      btn.querySelector("p")?.classList.replace("text-n-50", "text-n-600");
    });

    // Highlight active tab
    const activeBtn = tabButtons[tabIndex];
    activeBtn.classList.replace("bg-white", "bg-orange-500");
    activeBtn.querySelector("p").classList.replace("text-n-600", "text-n-50");

    // Show only this section
    sectionEls.forEach((sectionEl, i) => {
      sectionEl.classList.toggle("hidden", i !== tabIndex);
      sectionEl.classList.toggle("block", i === tabIndex);
    });

    destroyOtherSectionAccordions(tabIndex);
    setupSectionAccordion(sectionEls[tabIndex]);

    const accordionAPI = getAccordionAPI(sectionEls[tabIndex]);
    accordionAPI && accordionAPI.restartAutoplay?.();
  }

  // Tab click events
  tabsContainer.addEventListener("click", (e) => {
    const tabButton = e.target.closest(".tab-item");
    if (!tabButton) return;
    const index = Number(tabButton.dataset.index || 0);
    activateTab(index);
  });

  // Initialize first tab
  activateTab(0);
</script>
