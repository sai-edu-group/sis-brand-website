---
// COMPONENTS //
import CommonHeader from "../../components/CommonHeader.astro";

// DATA //
import {
  testimonials,
  sectionHeaderContent,
} from "../../data/home/testimonials";
---

<section>
  <div
    class="container mx-auto flex flex-col gap-12 px-6 py-16 md:gap-20 md:px-4 md:py-24 lg:px-8 lg:py-32 2xl:px-0"
  >
    <!-- Header with Lines -->
    <CommonHeader {...sectionHeaderContent} />

    <div class="flex flex-col gap-10 overflow-hidden" id="testimonial-slider">
      <!-- Embla slider -->
      <div class="" id="data-embla-viewport" data-embla-viewport>
        <div class="flex" data-embla-container>
          {
            testimonials.map((testimonialsItem) => (
              <div class="w-full shrink-0" data-embla-slide>
                <div class="border-n-200 flex w-full flex-col items-center justify-between overflow-hidden rounded-xl border-2 xl:flex-row">
                  {/* Image wrapper  */}
                  <div class="relative w-full xl:w-[40%]">
                    <img
                      src={testimonialsItem.thumbnail}
                      alt={testimonialsItem.parentName}
                      class="h-[350px] w-full object-cover md:h-[370px] xl:h-[450px]"
                    />

                    {/* Play Button */}
                    <button
                      type="button"
                      class="text-n-50 absolute top-1/2 left-1/2 flex size-20 -translate-x-1/2 -translate-y-1/2 items-center justify-center rounded-full bg-black/40 backdrop-blur transition hover:scale-105 md:size-16"
                      data-video-trigger
                      data-video-url={testimonialsItem.videoUrl}
                      aria-label={`Play testimonial from ${testimonialsItem.parentName}`}
                    >
                      <svg
                        class="mx-auto size-11 md:size-9/12"
                        xmlns="http://www.w3.org/2000/svg"
                        width="76"
                        height="76"
                        viewBox="0 0 76 76"
                        fill="none"
                      >
                        <path
                          fill-rule="evenodd"
                          clip-rule="evenodd"
                          d="M35.1118 3.05433C28.3624 3.45228 22.6224 5.01798 17.9999 7.72195C13.6265 10.2802 10.28 13.6267 7.72177 18.0001C3.95864 24.4332 2.35679 33.2522 3.20354 42.8745C3.69607 48.4706 5.31164 53.8788 7.72177 57.999C10.2764 62.3663 13.6312 65.7217 17.9958 68.2747C24.4321 72.0396 33.3361 73.6544 42.9118 72.7932C48.5361 72.2874 53.8769 70.6883 58.0029 68.2747C63.8309 64.8656 67.9983 59.8805 70.459 53.3745C72.874 46.9894 73.6336 38.7355 72.5288 30.8853C71.044 20.3347 66.109 12.466 58.0029 7.72435C52.6484 4.5922 45.5866 2.93815 37.7743 2.98638C36.8462 2.99215 35.6481 3.02268 35.1118 3.05433ZM35.3743 8.41855C35.1887 8.4337 34.5643 8.48343 33.9868 8.52903C28.2797 8.9797 23.0551 10.6729 19.1743 13.3295C13.963 16.897 10.5694 22.4067 9.13019 29.637C8.58044 32.3991 8.41184 34.3613 8.41184 37.9995C8.41184 39.8649 8.44799 41.337 8.50949 41.9745C8.98297 46.882 9.96269 50.5644 11.7332 54.0911C14.5257 59.6533 19.1098 63.5725 25.3175 65.7051C27.9829 66.6207 30.6175 67.1607 34.0243 67.4894C35.3848 67.6206 40.6138 67.6206 41.9743 67.4894C48.9218 66.8191 54.0689 64.9529 58.2796 61.5777C63.1378 57.6833 66.2303 51.6554 67.2401 44.112C67.5421 41.8563 67.585 41.0964 67.585 37.9995C67.585 36.0652 67.5497 34.6079 67.4878 33.987C66.9955 29.0439 66.0288 25.4204 64.2655 21.908C61.473 16.3458 56.8889 12.4266 50.6812 10.2939C48.099 9.40683 45.6629 8.89353 42.4243 8.55408C41.4062 8.44743 36.2384 8.34805 35.3743 8.41855ZM33.0493 22.942C31.755 23.0631 30.4301 23.5831 29.3368 24.3991C27.9088 25.4651 26.8881 27.0889 26.516 28.887C26.3845 29.5221 26.3763 30.0612 26.3763 37.9995C26.3763 45.9379 26.3845 46.4769 26.516 47.112C26.787 48.4215 27.4572 49.7355 28.3687 50.7446C29.1054 51.5601 30.3397 52.3459 31.4907 52.7323C32.8768 53.1976 34.567 53.2092 35.9743 52.7629C37.1011 52.4056 41.5063 49.9447 44.7118 47.8819C49.7676 44.6283 52.375 42.0841 53.2369 39.5634C53.4521 38.934 53.4767 38.7735 53.4767 37.9995C53.4767 37.2256 53.4521 37.065 53.2369 36.4357C52.4833 34.2317 50.4383 32.0612 46.5575 29.3464C43.4965 27.2052 37.5908 23.7876 36.0361 23.2578C35.1712 22.9631 34.0692 22.8466 33.0493 22.942ZM33.1767 28.3578C32.5153 28.5937 31.9215 29.2205 31.7944 29.8166C31.7628 29.9653 31.7368 33.6983 31.7368 38.112C31.7368 46.1336 31.7369 46.1372 31.8961 46.4812C32.3118 47.3802 33.312 47.9044 34.1751 47.6758C34.7875 47.5137 38.6586 45.3498 41.1841 43.758C42.6768 42.8171 44.3502 41.6505 45.4243 40.8017C46.2381 40.1587 47.7442 38.6472 47.9361 38.2808C48.0826 38.0011 48.0826 37.998 47.9351 37.7229C47.7379 37.3548 46.7439 36.311 45.9511 35.6394C43.8928 33.8957 40.7591 31.8555 36.5503 29.5191C34.2353 28.234 33.8732 28.1094 33.1767 28.3578Z"
                          fill="currentColor"
                        />
                      </svg>
                    </button>
                  </div>

                  <div class="font-secondary relative flex flex-col gap-5 px-8 py-8 md:gap-8 md:px-16 md:py-12 xl:w-[58%] xl:p-10 2xl:pr-24">
                    {/* Illustration  */}
                    <div class="absolute -top-[16%] -right-[4%] -z-1 cursor-pointer text-orange-100 md:-top-[6%] lg:-top-[18%] lg:-right-[12%]">
                      <svg
                        class="w-40 md:w-[268px] lg:w-[370px]"
                        xmlns="http://www.w3.org/2000/svg"
                        width="370"
                        height="276"
                        viewBox="0 0 370 276"
                        fill="none"
                      >
                        <path
                          d="M195.253 168.98C195.253 139.69 199.763 114.531 208.782 93.502C217.801 71.7225 229.451 54.0735 243.732 40.5551C258.012 26.2857 274.171 16.147 292.21 10.1388C311 3.37959 329.414 0 347.452 0V39.4286C327.911 39.4286 309.496 46.1878 292.21 59.7062C275.674 72.4735 265.904 90.1225 262.897 112.653C265.152 111.902 267.783 111.151 270.789 110.4C273.044 109.649 275.674 108.898 278.681 108.147C282.439 107.396 286.573 107.02 291.082 107.02C313.63 107.02 332.42 115.657 347.452 132.931C362.484 149.453 370 168.98 370 191.51C370 214.041 362.108 233.943 346.325 251.216C331.293 267.739 311 276 285.445 276C256.884 276 234.712 265.486 218.929 244.457C203.145 222.678 195.253 197.518 195.253 168.98ZM0 168.98C0 139.69 4.50959 114.531 13.5288 93.502C22.5479 71.7225 34.1977 54.0735 48.4781 40.5551C62.7585 26.2857 78.9178 16.147 96.9562 10.1388C115.746 3.37959 134.16 0 152.199 0V39.4286C132.657 39.4286 114.243 46.1878 96.9562 59.7062C80.421 72.4735 70.6502 90.1225 67.6439 112.653C69.8986 111.902 72.5292 111.151 75.5356 110.4C77.7904 109.649 80.421 108.898 83.4274 108.147C87.1854 107.396 91.3192 107.02 95.8288 107.02C118.377 107.02 137.167 115.657 152.199 132.931C167.231 149.453 174.747 168.98 174.747 191.51C174.747 214.041 166.855 233.943 151.071 251.216C136.039 267.739 115.746 276 90.1918 276C61.6311 276 39.4589 265.486 23.6753 244.457C7.89178 222.678 0 197.518 0 168.98Z"
                          fill="currentColor"
                        />
                      </svg>
                    </div>

                    <p class="text-n-600 text-sm leading-normal font-normal md:text-xl lg:text-2xl">
                      “{testimonialsItem.message}”
                    </p>
                    {/* Name wrapper */}
                    <div>
                      <p class="text-2xl leading-normal font-semibold text-orange-500 md:text-3xl lg:text-4xl">
                        {testimonialsItem.parentName}
                      </p>
                      <p class="text-n-500 text-sm leading-normal font-normal md:text-lg lg:text-xl">
                        {testimonialsItem.designation}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </div>

      <!-- Buttons wrapper -->
      <div class="flex items-center justify-center gap-8 md:gap-12 lg:gap-20">
        <!--  Prev button -->
        <button
          type="button"
          id="prevButton"
          class="bg-n-100 border-n-200 hover:bg-n-200 hidden size-11 cursor-pointer items-center justify-center rounded-full border p-1 md:size-14"
          data-prev
          aria-label="Previous"
          data-embla-prev
        >
          <span class="inline-flex">
            <svg
              class="size-5 md:size-7"
              xmlns="http://www.w3.org/2000/svg"
              width="29"
              height="29"
              viewBox="0 0 29 29"
              fill="none"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M10.7964 5.9684C11.1229 6.08513 11.3018 6.26134 11.4283 6.59064C11.508 6.79812 11.4864 7.12836 11.3787 7.34849C11.2662 7.57834 11.1138 7.71283 10.7461 7.90664C9.79415 8.40832 8.96949 8.96597 8.07436 9.71332C6.87991 10.7106 5.79432 11.8731 4.9112 13.1006L4.63927 13.4786L15.4848 13.4928C24.0302 13.5038 26.3516 13.5142 26.4303 13.5417C26.5724 13.5911 26.7876 13.7508 26.8948 13.8862C27.1716 14.236 27.1689 14.7713 26.8885 15.1269C26.7998 15.2395 26.5857 15.3923 26.4284 15.4554C26.3451 15.4888 24.7043 15.4967 15.4853 15.5086L4.64033 15.5226L4.87057 15.8446C5.88409 17.2621 7.18564 18.6147 8.58018 19.6997C9.2043 20.1853 9.95493 20.671 10.6752 21.0552C10.889 21.1693 11.1168 21.3136 11.1813 21.3758C11.353 21.5416 11.4541 21.7671 11.4704 22.0207C11.4868 22.2765 11.4462 22.432 11.3067 22.6477C11.1844 22.8371 11.0225 22.9577 10.7819 23.0388C10.4501 23.1506 10.2573 23.1093 9.68736 22.8041C8.20714 22.0117 6.90643 21.0347 5.53082 19.6819C4.05552 18.2311 2.97198 16.802 2.12251 15.1866C1.76731 14.5111 1.78623 14.3826 2.39896 13.3106C3.20897 11.8936 4.19992 10.6306 5.53115 9.31868C6.89671 7.97298 8.18353 7.00608 9.68436 6.19803C10.2552 5.8907 10.4606 5.84828 10.7964 5.9684Z"
                fill="#45556C"></path>
            </svg>
          </span>
        </button>

        <!-- Dots -->
        <div class="flex items-center gap-1.5 md:gap-2" data-embla-dots></div>

        <!-- Next button -->
        <button
          type="button"
          class="bg-n-100 border-n-200 hover:bg-n-200 hidden size-11 cursor-pointer items-center justify-center rounded-full border p-1 md:size-14"
          id="nextButton"
          data-embla-next
        >
          <span class="inline-flex rotate-180">
            <svg
              class="size-5 md:size-7"
              xmlns="http://www.w3.org/2000/svg"
              width="29"
              height="29"
              viewBox="0 0 29 29"
              fill="none"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M10.7964 5.9684C11.1229 6.08513 11.3018 6.26134 11.4283 6.59064C11.508 6.79812 11.4864 7.12836 11.3787 7.34849C11.2662 7.57834 11.1138 7.71283 10.7461 7.90664C9.79415 8.40832 8.96949 8.96597 8.07436 9.71332C6.87991 10.7106 5.79432 11.8731 4.9112 13.1006L4.63927 13.4786L15.4848 13.4928C24.0302 13.5038 26.3516 13.5142 26.4303 13.5417C26.5724 13.5911 26.7876 13.7508 26.8948 13.8862C27.1716 14.236 27.1689 14.7713 26.8885 15.1269C26.7998 15.2395 26.5857 15.3923 26.4284 15.4554C26.3451 15.4888 24.7043 15.4967 15.4853 15.5086L4.64033 15.5226L4.87057 15.8446C5.88409 17.2621 7.18564 18.6147 8.58018 19.6997C9.2043 20.1853 9.95493 20.671 10.6752 21.0552C10.889 21.1693 11.1168 21.3136 11.1813 21.3758C11.353 21.5416 11.4541 21.7671 11.4704 22.0207C11.4868 22.2765 11.4462 22.432 11.3067 22.6477C11.1844 22.8371 11.0225 22.9577 10.7819 23.0388C10.4501 23.1506 10.2573 23.1093 9.68736 22.8041C8.20714 22.0117 6.90643 21.0347 5.53082 19.6819C4.05552 18.2311 2.97198 16.802 2.12251 15.1866C1.76731 14.5111 1.78623 14.3826 2.39896 13.3106C3.20897 11.8936 4.19992 10.6306 5.53115 9.31868C6.89671 7.97298 8.18353 7.00608 9.68436 6.19803C10.2552 5.8907 10.4606 5.84828 10.7964 5.9684Z"
                fill="#45556C"></path>
            </svg>
          </span>
        </button>
      </div>
    </div>
    <!-- Video Modal -->
    <div
      id="testimonial-modal"
      class="testimonial-modal"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="testimonial-modal__backdrop" data-modal-close></div>
      <div class="testimonial-modal__dialog" role="document">
        <button
          type="button"
          class="testimonial-modal__close"
          aria-label="Close video"
          data-modal-close
        >
          ✕
        </button>
        <div class="testimonial-modal__frame">
          <iframe
            id="testimonial-iframe"
            src=""
            title="Testimonial video"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Component-level init: scoped to this slider only -->
<script type="module">
  import { initEmblaRoot } from "/js/embla.js";

  window.addEventListener("DOMContentLoaded", () => {
    const root = document.getElementById("testimonial-slider");

    initEmblaRoot(root);

    const modal = document.getElementById("testimonial-modal");
    const iframe = document.getElementById("testimonial-iframe");
    const closeTargets = document.querySelectorAll("[data-modal-close]");
    const triggers = document.querySelectorAll("[data-video-trigger]");

    const html = document.documentElement;

    const getEmbedUrl = (url) => {
      try {
        const parsed = new URL(url);
        if (parsed.hostname.includes("youtube")) {
          const videoId = parsed.searchParams.get("v");
          if (videoId) {
            const list = parsed.searchParams.get("list");
            return `https://www.youtube.com/embed/${videoId}${list ? `?list=${list}` : ""}`;
          }
        }
        return url;
      } catch (error) {
        console.error("Invalid video URL:", error);
        return url;
      }
    };

    const openModal = (url) => {
      if (!modal || !iframe) return;
      iframe.src = getEmbedUrl(url);
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      html.classList.add("overflow-hidden");
    };

    const closeModal = () => {
      if (!modal || !iframe) return;
      iframe.src = "";
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      html.classList.remove("overflow-hidden");
    };

    triggers.forEach((trigger) => {
      trigger.addEventListener("click", () => {
        const url = trigger.getAttribute("data-video-url") || "";
        openModal(url);
      });
    });

    closeTargets.forEach((closeTarget) => {
      closeTarget.addEventListener("click", closeModal);
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeModal();
      }
    });
  });
</script>

<style>
  .testimonial-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    background: rgba(0, 0, 0, 0.5);
    z-index: 50;
    opacity: 0;
    pointer-events: none;
    transition: opacity 200ms ease;
  }

  .testimonial-modal.open {
    opacity: 1;
    pointer-events: auto;
  }

  .testimonial-modal__backdrop {
    position: absolute;
    inset: 0;
  }

  .testimonial-modal__dialog {
    position: relative;
    background: #0f172a;
    border-radius: 1rem;
    width: min(900px, 100%);
    aspect-ratio: 16 / 9;
    padding: 0;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .testimonial-modal__close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(15, 23, 42, 0.6);
    color: white;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
  }

  .testimonial-modal__frame {
    width: 100%;
    height: 100%;
  }

  .testimonial-modal__frame iframe {
    width: 100%;
    height: 100%;
  }

  @media (max-width: 768px) {
    .testimonial-modal {
      padding: 1rem;
    }
  }
</style>
